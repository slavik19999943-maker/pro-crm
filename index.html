<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM FIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: #fff; padding: 15px; margin: 0; }
        .card { background: #1c1c1e; padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #333; background: #2c2c2e; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-add { width: 100%; background: #0088cc; border: none; padding: 15px; border-radius: 12px; color: #fff; font-weight: bold; font-size: 16px; }
        .task-item { background: #1c1c1e; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #0088cc; }
        .task-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px; }
        .task-text { font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3 id="userDisplay" style="margin-top:0; text-align:center;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</h3>
        <input type="text" id="taskText" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏">
        <div style="display:flex; gap:10px;">
            <input type="date" id="taskDate">
            <input type="time" id="taskTime">
        </div>
        <select id="taskPrio">
            <option value="low">–û–±—ã—á–Ω—ã–π</option>
            <option value="mid">–í–∞–∂–Ω—ã–π</option>
            <option value="high">–°–†–û–ß–ù–û üî•</option>
        </select>
        <button class="btn-add" onclick="sendTask()">–°–û–ó–î–ê–¢–¨</button>
    </div>

    <div id="tasksList"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const URL = 'https://roiadameugqibsqndbvr.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvaWFkYW1ldWdxaWJzcW5kYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzIxMjgsImV4cCI6MjA4NTcwODEyOH0.2L9vgUDFmXXO7__maMpsNPtAcZ47qsPE4IoElkKfUXs';
    
    let supabaseClient;

    try {
        supabaseClient = supabase.createClient(URL, KEY);
        console.log("Supabase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    } catch (e) {
        document.getElementById('userDisplay').innerText = "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞!";
    }

    const author = tg.initDataUnsafe?.user?.first_name || "–ê–¥–º–∏–Ω";
    document.getElementById('userDisplay').innerText = "–ó–∞–¥–∞—á–∏: " + author;

    async function getTasks() {
        try {
            const { data, error } = await supabaseClient.from('tasks').select('*').order('id', { ascending: false });
            if (error) throw error;

            const list = document.getElementById('tasksList');
            list.innerHTML = '';
            data.forEach(t => {
                const div = document.createElement('div');
                div.className = `task-item ${t.priority === 'high' ? 'border-left-color: #ff3b30;' : ''}`;
                div.innerHTML = `
                    <div class="task-header">
                        <span>üìÖ ${t.due_date || '-'} ${t.task_time || ''}</span>
                        <span>üë§ ${t.author || '–ê–Ω–æ–Ω–∏–º'}</span>
                    </div>
                    <div class="task-text">${t.text}</div>
                    <button onclick="remove(${t.id})" style="background:none; border:none; color:#ff3b30; font-size:12px;">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                list.appendChild(div);
            });
        } catch (err) {
            document.getElementById('userDisplay').innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
            console.error(err);
        }
    }

    async function sendTask() {
        const text = document.getElementById('taskText').value;
        const date = document.getElementById('taskDate').value;
        const time = document.getElementById('taskTime').value;
        const prio = document.getElementById('taskPrio').value;

        if (!text) return alert("–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç!");

        try {
            const { error } = await supabaseClient.from('tasks').insert([{
                text: text,
                due_date: date || null,
                task_time: time || null,
                priority: prio,
                author: author,
                is_done: false
            }]);

            if (error) throw error;
            document.getElementById('taskText').value = '';
            getTasks();
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message);
        }
    }

    async function remove(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            await supabaseClient.from('tasks').delete().eq('id', id);
            getTasks();
        }
    }

    // –ó–∞–ø—É—Å–∫
    getTasks();
</script>
</body>
</html>
