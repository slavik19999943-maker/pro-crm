<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM FIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; padding: 10px; margin: 0; }
        .card { background: #1c1c1e; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #444; background: #2c2c2e; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-add { width: 100%; background: #0088cc; border: none; padding: 15px; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; }
        .task-card { background: #1c1c1e; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #0088cc; position: relative; }
        .task-card.high { border-left-color: #ff3b30; }
        .task-info { font-size: 11px; color: #888; margin-bottom: 4px; }
        .task-text { font-size: 15px; color: #eee; }
        .del-btn { color: #ff3b30; font-size: 11px; background: none; border: none; padding: 5px 0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="card">
        <h3 id="status" style="margin: 0 0 10px 0; text-align: center; font-size: 16px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
        <input type="text" id="inpText" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏">
        <div style="display:flex; gap:5px;">
            <input type="date" id="inpDate">
            <input type="time" id="inpTime">
        </div>
        <select id="inpPrio">
            <option value="low">–û–±—ã—á–Ω—ã–π</option>
            <option value="high">–°–†–û–ß–ù–û üî•</option>
        </select>
        <button class="btn-add" id="btnCreate">–°–û–ó–î–ê–¢–¨</button>
    </div>

    <div id="list"></div>

<script>
    // 1. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TG
    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand();

    // 2. –î–∞–Ω–Ω—ã–µ Supabase
    const SB_URL = 'https://roiadameugqibsqndbvr.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvaWFkYW1ldWdxaWJzcW5kYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzIxMjgsImV4cCI6MjA4NTcwODEyOH0.2L9vgUDFmXXO7__maMpsNPtAcZ47qsPE4IoElkKfUXs';
    
    let client;
    try {
        client = supabase.createClient(SB_URL, SB_KEY);
    } catch (e) {
        document.getElementById('status').innerText = "–û—à–∏–±–∫–∞ Supabase!";
    }

    const userName = tg?.initDataUnsafe?.user?.first_name || "–ê–¥–º–∏–Ω";
    const statusEl = document.getElementById('status');

    // 3. –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    async function loadTasks() {
        if (!client) return;
        try {
            const { data, error } = await client.from('tasks').select('*').order('id', { ascending: false });
            if (error) throw error;

            const listEl = document.getElementById('list');
            listEl.innerHTML = '';
            
            data.forEach(t => {
                const div = document.createElement('div');
                div.className = `task-card ${t.priority === 'high' ? 'high' : ''}`;
                div.innerHTML = `
                    <div class="task-info">üìÖ ${t.due_date || '-'} | üë§ ${t.author || '...'}</div>
                    <div class="task-text">${t.text || ''}</div>
                    <button class="del-btn" onclick="deleteItem(${t.id})">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                listEl.appendChild(div);
            });
            statusEl.innerText = "–ó–∞–¥–∞—á–∏: " + userName;
        } catch (err) {
            statusEl.innerText = "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö";
            console.error(err);
        }
    }

    // 4. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è
    async function createTask() {
        const text = document.getElementById('inpText')?.value;
        const date = document.getElementById('inpDate')?.value;
        const time = document.getElementById('inpTime')?.value;
        const prio = document.getElementById('inpPrio')?.value;

        if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç");

        try {
            const { error } = await client.from('tasks').insert([{
                text: text,
                due_date: date || null,
                task_time: time || null,
                priority: prio || 'low',
                author: userName,
                is_done: false
            }]);

            if (error) throw error;
            document.getElementById('inpText').value = '';
            loadTasks();
        } catch (err) {
            alert("–û—à–∏–±–∫–∞: " + (err.message || "–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É"));
        }
    }

    // 5. –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    window.deleteItem = async (id) => {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
        await client.from('tasks').delete().eq('id', id);
        loadTasks();
    };

    // –°—Ç–∞—Ä—Ç
    document.getElementById('btnCreate').onclick = createTask;
    loadTasks();
</script>
</body>
</html>
