<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM –°–∏—Å—Ç–µ–º–∞ PRO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #121212; color: white; padding: 15px; margin: 0; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        h2 { text-align: center; color: #0088cc; font-size: 18px; margin-top: 0; }
        .input-group { display: flex; gap: 8px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #2a2a2a; color: white; outline: none; }
        button { padding: 12px; border: none; border-radius: 10px; cursor: pointer; background: #0088cc; color: white; font-weight: bold; }
        .task-item { background: #2a2a2a; padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid #0088cc; }
        .task-info { font-size: 11px; color: #888; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .task-text { font-size: 16px; display: block; margin-bottom: 12px; }
        .done { opacity: 0.4; border-left-color: #4caf50; }
        .done .task-text { text-decoration: line-through; }
        .btns { display: flex; gap: 8px; }
        .btn-ok { background: #2ecc71; flex: 1; font-size: 12px; }
        .btn-del { background: #e74c3c; flex: 1; font-size: 12px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <div class="input-group">
            <input type="text" id="taskInput" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
            <button onclick="addTask()">–û–ö</button>
        </div>
        <div id="taskList"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user?.first_name || "–ê–¥–º–∏–Ω";
        document.getElementById('userName').innerText = "–ó–∞–¥–∞—á–∏: " + user;

        const SUPABASE_URL = 'https://roiadameugqibsqndbvr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvaWFkYW1ldWdxaWJzcW5kYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg2MTQzMjcsImV4cCI6MjA1NDE5MDMyN30.8V4UvH-P2D4X-S9Y0-N1-Z2-A3-B4-C5-D6-E7-F8-G9'; 

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadTasks() {
            try {
                const { data, error } = await supabaseClient.from('tasks').select('*').order('id', { ascending: false });
                if (error) throw error;
                const list = document.getElementById('taskList');
                list.innerHTML = '';
                data.forEach(task => {
                    const time = new Date(task.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const item = document.createElement('div');
                    item.className = `task-item ${task.is_done ? 'done' : ''}`;
                    item.innerHTML = `
                        <div class="task-info"><span>üë§ ${task.author || '–ê–¥–º–∏–Ω'}</span> <span>‚è∞ ${time}</span></div>
                        <span class="task-text">${task.text}</span>
                        <div class="btns">
                            <button class="btn-ok" onclick="toggleDone(${task.id}, ${task.is_done})">${task.is_done ? '–í–µ—Ä–Ω—É—Ç—å' : '–ì–æ—Ç–æ–≤–æ'}</button>
                            <button class="btn-del" onclick="deleteTask(${task.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>`;
                    list.appendChild(item);
                });
            } catch (err) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message); }
        }

        async function addTask() {
            const input = document.getElementById('taskInput');
            if (!input.value) return;
            try {
                const { error } = await supabaseClient.from('tasks').insert([
                    { text: input.value, author: user, is_done: false }
                ]);
                if (error) throw error;
                input.value = '';
                loadTasks();
            } catch (err) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message); }
        }

        async function toggleDone(id, currentStatus) {
            await supabaseClient.from('tasks').update({ is_done: !currentStatus }).eq('id', id);
            loadTasks();
        }

        async function deleteTask(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
                await supabaseClient.from('tasks').delete().eq('id', id);
                loadTasks();
            }
        }

        loadTasks();
    </script>
</body>
</html>
