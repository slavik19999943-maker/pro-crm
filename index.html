<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM PRO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: white; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        h2 { text-align: center; color: #0088cc; font-size: 22px; margin-bottom: 20px; }
        
        .input-area { display: flex; gap: 8px; margin-bottom: 25px; position: sticky; top: 10px; z-index: 10; }
        input { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid #333; background: #1a1a1a; color: white; outline: none; font-size: 16px; }
        .add-btn { background: #0088cc; border: none; border-radius: 12px; padding: 0 20px; color: white; font-weight: bold; cursor: pointer; }

        .task-card { background: #1a1a1a; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #262626; transition: 0.3s; }
        .task-header { display: flex; justify-content: space-between; font-size: 11px; color: #777; margin-bottom: 10px; }
        .task-text { font-size: 17px; line-height: 1.4; display: block; margin-bottom: 15px; word-wrap: break-word; }
        
        .done { opacity: 0.5; background: #0d0d0d; }
        .done .task-text { text-decoration: line-through; color: #555; }

        .actions { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-check { background: #27ae60; color: white; }
        .btn-delete { background: #c0392b; color: white; }
        
        .empty { text-align: center; color: #444; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="title">–ó–∞–¥–∞—á–∏</h2>
    
    <div class="input-area">
        <input type="text" id="taskInput" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
        <button class="add-btn" onclick="addTask()">–û–ö</button>
    </div>

    <div id="taskList"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    const userName = tg.initDataUnsafe?.user?.first_name || "–ê–¥–º–∏–Ω";
    document.getElementById('title').innerText = "–ó–∞–¥–∞—á–∏: " + userName;

    const URL = 'https://roiadameugqibsqndbvr.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvaWFkYW1ldWdxaWJzcW5kYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzIxMjgsImV4cCI6MjA4NTcwODEyOH0.2L9vgUDFmXXO7__maMpsNPtAcZ47qsPE4IoElkKfUXs';
    const supabaseClient = supabase.createClient(URL, KEY);

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
    async function loadTasks() {
        const { data, error } = await supabaseClient
            .from('tasks')
            .select('*')
            .order('id', { ascending: false });

        if (error) return console.error(error);

        const list = document.getElementById('taskList');
        if (data.length === 0) {
            list.innerHTML = '<div class="empty">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç...</div>';
            return;
        }

        list.innerHTML = '';
        data.forEach(task => {
            const date = new Date(task.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const div = document.createElement('div');
            div.className = `task-card ${task.is_done ? 'done' : ''}`;
            div.innerHTML = `
                <div class="task-header">
                    <span>üë§ ${task.author || '–ê–Ω–æ–Ω–∏–º'}</span>
                    <span>üïí ${date}</span>
                </div>
                <div class="task-text">${task.text}</div>
                <div class="actions">
                    <button class="btn-check" onclick="toggleTask(${task.id}, ${task.is_done})">
                        ${task.is_done ? '–í–µ—Ä–Ω—É—Ç—å' : '–ì–æ—Ç–æ–≤–æ'}
                    </button>
                    <button class="btn-delete" onclick="deleteTask(${task.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    async function addTask() {
        const input = document.getElementById('taskInput');
        if (!input.value.trim()) return;

        const { error } = await supabaseClient.from('tasks').insert([
            { text: input.value, author: userName, is_done: false }
        ]);

        if (error) {
            alert("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—É.");
        } else {
            input.value = '';
            loadTasks();
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ì–æ—Ç–æ–≤–æ/–ù–µ –≥–æ—Ç–æ–≤–æ
    async function toggleTask(id, currentStatus) {
        await supabaseClient.from('tasks').update({ is_done: !currentStatus }).eq('id', id);
        loadTasks();
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function deleteTask(id) {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
            await supabaseClient.from('tasks').delete().eq('id', id);
            loadTasks();
        }
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadTasks();
</script>

</body>
</html>
