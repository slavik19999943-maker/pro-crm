<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM —Å –ö–∞–ª–µ–Ω–¥–∞—Ä–µ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: white; padding: 15px; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        h2 { text-align: center; color: #0088cc; margin-bottom: 20px; }
        
        .input-area { background: #1a1a1a; padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #333; background: #262626; color: white; box-sizing: border-box; }
        .add-btn { width: 100%; background: #0088cc; border: none; border-radius: 10px; padding: 12px; color: white; font-weight: bold; cursor: pointer; }

        .date-section { margin-top: 25px; border-bottom: 1px solid #222; padding-bottom: 5px; color: #0088cc; font-size: 14px; font-weight: bold; text-transform: uppercase; }
        .task-card { background: #1a1a1a; border-radius: 12px; padding: 15px; margin-top: 10px; border: 1px solid #262626; }
        .task-header { display: flex; justify-content: space-between; font-size: 11px; color: #777; margin-bottom: 8px; }
        .task-text { font-size: 16px; margin-bottom: 12px; }
        
        .done { opacity: 0.4; text-decoration: line-through; }
        .actions { display: flex; gap: 8px; }
        .btn-check { background: #27ae60; color: white; flex: 2; border: none; padding: 8px; border-radius: 8px; cursor: pointer; }
        .btn-delete { background: #c0392b; color: white; flex: 1; border: none; padding: 8px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="userName">–ú–æ–∏ –ó–∞–¥–∞—á–∏</h2>
    
    <div class="input-area">
        <input type="text" id="taskInput" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
        <input type="date" id="dateInput"> <button class="add-btn" onclick="addTask()">–î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù</button>
    </div>

    <div id="taskList"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const userName = tg.initDataUnsafe?.user?.first_name || "–ê–¥–º–∏–Ω";
    document.getElementById('userName').innerText = userName;

    const URL = 'https://roiadameugqibsqndbvr.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvaWFkYW1ldWdxaWJzcW5kYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzIxMjgsImV4cCI6MjA4NTcwODEyOH0.2L9vgUDFmXXO7__maMpsNPtAcZ47qsPE4IoElkKfUXs';
    const supabaseClient = supabase.createClient(URL, KEY);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ –∏–Ω–ø—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('dateInput').valueAsDate = new Date();

    async function loadTasks() {
        const { data, error } = await supabaseClient.from('tasks').select('*').order('due_date', { ascending: true });
        if (error) return;

        const list = document.getElementById('taskList');
        list.innerHTML = '';

        let lastDate = "";

        data.forEach(task => {
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
            if (task.due_date !== lastDate) {
                const section = document.createElement('div');
                section.className = 'date-section';
                section.innerText = task.due_date || "–ë–µ–∑ –¥–∞—Ç—ã";
                list.appendChild(section);
                lastDate = task.due_date;
            }

            const div = document.createElement('div');
            div.className = `task-card ${task.is_done ? 'done' : ''}`;
            div.innerHTML = `
                <div class="task-header"><span>üë§ ${task.author}</span></div>
                <div class="task-text">${task.text}</div>
                <div class="actions">
                    <button class="btn-check" onclick="toggleTask(${task.id}, ${task.is_done})">‚úî</button>
                    <button class="btn-delete" onclick="deleteTask(${task.id})">üóë</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function addTask() {
        const text = document.getElementById('taskInput').value;
        const date = document.getElementById('dateInput').value;
        if (!text) return;

        await supabaseClient.from('tasks').insert([{ 
            text: text, 
            due_date: date, 
            author: userName, 
            is_done: false 
        }]);
        
        document.getElementById('taskInput').value = '';
        loadTasks();
    }

    async function toggleTask(id, status) {
        await supabaseClient.from('tasks').update({ is_done: !status }).eq('id', id);
        loadTasks();
    }

    async function deleteTask(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            await supabaseClient.from('tasks').delete().eq('id', id);
            loadTasks();
        }
    }

    loadTasks();
</script>
</body>
</html>
