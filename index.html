<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro CRM System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-in-work: #e3f2fd; /* –°–∏–Ω–∏–π */
            --card-completed: #e8f5e9; /* –ó–µ–ª–µ–Ω—ã–π */
            --card-rejected: #ffebee; /* –ö—Ä–∞—Å–Ω—ã–π */
            --primary: #0088cc;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 12px; color: #333; }
        
        .team-label { font-size: 11px; color: #888; font-weight: bold; margin: 0 0 8px 4px; text-transform: uppercase; }
        .team-section { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 12px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .manager-chip { background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--primary); white-space: nowrap; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 14px; }
        .plus-icon { background: var(--primary); color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

        .form-section { background: white; padding: 16px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        select, textarea, input { width: 100%; margin-bottom: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; -webkit-appearance: none; }
        button.add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 16px; }

        .day-header { font-weight: 800; color: #999; margin: 25px 0 12px 5px; text-transform: uppercase; font-size: 11px; letter-spacing: 1.2px; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px; }

        .task-card { padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 6px solid transparent; }
        .status-in_work { background: var(--card-in-work); border-left-color: #2196f3; }
        .status-completed { background: var(--card-completed); border-left-color: #4caf50; }
        .status-rejected { background: var(--card-rejected); border-left-color: #f44336; }

        .company-name { font-weight: 800; font-size: 16px; color: #1a1a1a; margin-bottom: 6px; }
        .task-text { font-size: 15px; line-height: 1.4; margin-bottom: 10px; color: #444; white-space: pre-wrap; }
        .meta-line { font-size: 11px; color: #777; display: flex; justify-content: space-between; background: rgba(255,255,255,0.5); padding: 5px 8px; border-radius: 6px; }
        
        .actions { display: flex; gap: 8px; margin-top: 12px; }
        .btn-status { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); font-size: 10px; font-weight: bold; background: white; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="team-label">–ö–æ–º–∞–Ω–¥–∞ (–Ω–∞–∂–º–∏ + —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å):</div>
    <div id="team-list" class="team-section"></div>

    <div class="form-section">
        <select id="company-select"><option value="">üè¢ –í—ã–±—Ä–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é...</option></select>
        <textarea id="task-text" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" rows="2"></textarea>
        <div style="display: flex; gap: 10px;">
            <input type="date" id="task-date">
            <input type="time" id="task-time">
        </div>
        <select id="manager-select"><option value="">üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞...</option></select>
        <button class="add-btn" onclick="addTask()">–ü–û–°–¢–ê–í–ò–¢–¨ –ó–ê–î–ê–ß–£</button>
    </div>

    <div id="tasks-container"></div>

<script>
    const SUPABASE_URL = 'https://ivfksmzhvubfubvfqvpw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2ZmtzbXpodnViZnVidmZxdnB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNzM0NjYsImV4cCI6MjA1MTg0OTQ2Nn0.89u2Ait783u_jVfC7tX_hX_0nE_w2o22yX_jX_0nE_w'; 
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tg = window.Telegram.WebApp;
    tg.expand();

    async function init() {
        document.getElementById('task-date').valueAsDate = new Date();
        
        // 1. –ê–í–¢–û–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø: –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≥–æ, –∫—Ç–æ –æ—Ç–∫—Ä—ã–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        const user = tg.initDataUnsafe?.user;
        if (user) {
            const { data: existing } = await supabaseClient
                .from('team')
                .select('*')
                .eq('telegram_id', user.id.toString());

            if (!existing || existing.length === 0) {
                await supabaseClient.from('team').insert([{
                    name: user.first_name || '–ú–µ–Ω–µ–¥–∂–µ—Ä',
                    telegram_id: user.id.toString()
                }]);
            }
        }

        await loadTeam();
        await loadCompanies();
        await loadTasks();
    }

    async function loadTeam() {
        const { data } = await supabaseClient.from('team').select('*').order('name');
        if (!data) return;
        
        const list = document.getElementById('team-list');
        const select = document.getElementById('manager-select');
        
        list.innerHTML = data.map(m => `
            <div class="manager-chip">
                ${m.name} <div class="plus-icon" onclick="quickTask('${m.name}')">+</div>
            </div>
        `).join('');

        select.innerHTML = '<option value="">üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞...</option>' + 
            data.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
    }

    async function loadCompanies() {
        const { data } = await supabaseClient.from('companies').select('*').order('name');
        if (!data) return;
        document.getElementById('company-select').innerHTML = '<option value="">üè¢ –í—ã–±—Ä–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é...</option>' + 
            data.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    function quickTask(name) {
        document.getElementById('manager-select').value = name;
        document.getElementById('task-text').focus();
        tg.HapticFeedback.impactOccurred('light');
    }

    async function addTask() {
        const company = document.getElementById('company-select').value;
        const text = document.getElementById('task-text').value;
        const date = document.getElementById('task-date').value;
        const time = document.getElementById('task-time').value;
        const manager = document.getElementById('manager-select').value;

        if (!company || !text) {
            tg.showAlert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é –∏ —Ç–µ–∫—Å—Ç!');
            return;
        }

        const { error } = await supabaseClient.from('tasks').insert([{
            company_name: company,
            task_text: text,
            due_date: date,
            due_time: time,
            manager_name: manager,
            created_by: tg.initDataUnsafe?.user?.first_name || 'Admin',
            status: 'in_work'
        }]);

        if (!error) {
            tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('task-text').value = '';
            loadTasks();
        }
    }

    async function updateStatus(id, newStatus) {
        await supabaseClient.from('tasks').update({ status: newStatus }).eq('id', id);
        tg.HapticFeedback.selectionChanged();
        loadTasks();
    }

    async function loadTasks() {
        const { data } = await supabaseClient.from('tasks').select('*').order('due_date', { ascending: true });
        const container = document.getElementById('tasks-container');
        container.innerHTML = '';

        const groups = {};
        data?.forEach(t => {
            const d = t.due_date || '–ë–µ–∑ –¥–∞—Ç—ã';
            if (!groups[d]) groups[d] = [];
            groups[d].push(t);
        });

        for (const date in groups) {
            const headerText = date === '–ë–µ–∑ –¥–∞—Ç—ã' ? date : new Date(date).toLocaleDateString('ru-RU', {weekday: 'short', day: 'numeric', month: 'long'});
            container.innerHTML += `<div class="day-header">${headerText}</div>`;
            
            groups[date].forEach(t => {
                container.innerHTML += `
                    <div class="task-card status-${t.status}">
                        <div class="company-name">üè¢ ${t.company_name}</div>
                        <div class="task-text">${t.task_text}</div>
                        <div class="meta-line">
                            <span>üïí ${t.due_time?.slice(0,5) || '--:--'} | üë§ ${t.manager_name || '–í—Å–µ–º'}</span>
                            <span>–û—Ç: ${t.created_by}</span>
                        </div>
                        <div class="actions">
                            <button class="btn-status" onclick="updateStatus(${t.id}, 'completed')" style="color: #2e7d32">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
                            <button class="btn-status" onclick="updateStatus(${t.id}, 'rejected')" style="color: #c62828">‚ùå –û—Ç–º–µ–Ω–∞</button>
                            <button class="btn-status" onclick="updateStatus(${t.id}, 'in_work')" style="color: #1565c0">‚è≥ –ñ–¥–µ—Ç</button>
                        </div>
                    </div>
                `;
            });
        }
    }

    init();
</script>
</body>
</html>
