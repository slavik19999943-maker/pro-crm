<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM –°–∏—Å—Ç–µ–º–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 15px; margin: 0; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #0088cc; font-size: 18px; margin-bottom: 20px; }
        .input-group { display: flex; gap: 8px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #2a2a2a; color: white; outline: none; }
        button { padding: 12px; border: none; border-radius: 10px; cursor: pointer; background: #0088cc; color: white; font-weight: bold; }
        .task-item { background: #2a2a2a; padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid #0088cc; }
        .task-info { font-size: 11px; color: #888; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .task-text { font-size: 16px; display: block; margin-bottom: 10px; }
        .done { opacity: 0.4; border-left-color: #4caf50; }
        .done .task-text { text-decoration: line-through; }
        .btns { display: flex; gap: 5px; }
        .btn-ok { background: #2ecc71; flex: 1; font-size: 12px; }
        .btn-del { background: #e74c3c; flex: 1; font-size: 12px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="userName">–ú–æ–∏ –ó–∞–¥–∞—á–∏</h2>
        <div class="input-group">
            <input type="text" id="taskInput" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?">
            <button onclick="addTask()">–û–ö</button>
        </div>
        <div id="taskList"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe?.user?.first_name || "–ê–¥–º–∏–Ω";
        document.getElementById('userName').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user}!`;

        // –¢–í–û–ò –î–ê–ù–ù–´–ï –° –§–û–¢–û
        const SUPABASE_URL = 'https://roiadameugqibsqndbvr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvaWFkYW1ldWdxaWJzcW5kYnZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg2MTQzMjcsImV4cCI6MjA1NDE5MDMyN30.K_H-5xGkL-0pS0-w1-r2-v3-m4-j5-f6-h7-q8-s9'; 
        // –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ –∫–ª—é—á –≤—ã—à–µ –Ω–µ –ø–æ–¥–æ—à–µ–ª, —Å–∫–æ–ø–∏—Ä—É–π –µ–≥–æ –í–ï–°–¨ –∏–∑ Supabase (–æ–Ω –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π) –∏ –≤—Å—Ç–∞–≤—å –≤–º–µ—Å—Ç–æ –Ω–µ–≥–æ.

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadTasks() {
            const { data, error } = await supabaseClient.from('tasks').select('*').order('id', { ascending: false });
            if (error) return;
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            data.forEach(task => {
                const time = new Date(task.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const item = document.createElement('div');
                item.className = `task-item ${task.is_done ? 'done' : ''}`;
                item.innerHTML = `
                    <div class="task-info"><span>üë§ ${task.author || '–ê–¥–º–∏–Ω'}</span> <span>‚è∞ ${time}</span></div>
                    <span class="task-text">${task.text}</span>
                    <div class="btns">
                        <button class="btn-ok" onclick="toggleDone(${task.id}, ${task.is_done})">–ì–æ—Ç–æ–≤–æ</button>
                        <button class="btn-del" onclick="deleteTask(${task.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
                list.appendChild(item);
            });
        }

        async function addTask() {
            const input = document.getElementById('taskInput');
            if (!input.value) return;
            await supabaseClient.from('tasks').insert([{ text: input.value, author: user, is_done: false }]);
            input.value = '';
            loadTasks();
        }

        async function toggleDone(id, currentStatus) {
            await supabaseClient.from('tasks').update({ is_done: !currentStatus }).eq('id', id);
            loadTasks();
        }

        async function deleteTask(id) {
            await supabaseClient.from('tasks').delete().eq('id', id);
            loadTasks();
        }

        loadTasks();
    </script>
</body>
</html>
