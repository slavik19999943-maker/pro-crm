<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro CRM System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-in-work: #e3f2fd;
            --card-completed: #e8f5e9;
            --card-rejected: #ffebee;
            --primary: #0088cc;
            --my-task: #fff9c4;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 12px; color: #333; }
        
        .team-section { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 12px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .manager-chip { background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--primary); white-space: nowrap; display: flex; align-items: center; gap: 8px; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .plus-icon { background: var(--primary); color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; }

        .form-section { background: white; padding: 16px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input, textarea, select { width: 100%; margin-bottom: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        
        .btn-me { background: #ff9800; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; width: 100%; margin-bottom: 12px; cursor: pointer; }
        button.add-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 16px; }

        .day-header { font-weight: 800; color: #999; margin: 25px 0 12px 5px; text-transform: uppercase; font-size: 11px; letter-spacing: 1.2px; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px; }

        .task-card { padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border-left: 6px solid transparent; }
        .status-in_work { background: var(--card-in-work); border-left-color: #2196f3; }
        .status-completed { background: var(--card-completed); border-left-color: #4caf50; }
        .status-rejected { background: var(--card-rejected); border-left-color: #f44336; }
        .is-mine { background: var(--my-task) !important; border-left-color: #fbc02d; }

        .company-name { font-weight: 800; font-size: 16px; margin-bottom: 6px; }
        .task-text { font-size: 15px; line-height: 1.4; margin-bottom: 10px; white-space: pre-wrap; }
        .meta-line { font-size: 11px; color: #777; display: flex; justify-content: space-between; background: rgba(255,255,255,0.5); padding: 5px 8px; border-radius: 6px; }
        
        .actions { display: flex; gap: 8px; margin-top: 12px; }
        .btn-status { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); font-size: 12px; background: white; }
    </style>
</head>
<body>

    <div id="team-list" class="team-section"></div>

    <div class="form-section">
        <button class="btn-me" onclick="assignToMe()">‚≠ê –ù–ê–ó–ù–ê–ß–ò–¢–¨ –ú–ù–ï</button>
        
        <input list="companies-list" id="company-input" placeholder="üè¢ –í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é...">
        <datalist id="companies-list"></datalist>

        <textarea id="task-text" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" rows="2"></textarea>
        
        <div style="display: flex; gap: 10px;">
            <input type="date" id="task-date">
            <input type="time" id="task-time">
        </div>
        
        <select id="manager-select"></select>
        <button class="add-btn" onclick="addTask()">–ü–û–°–¢–ê–í–ò–¢–¨ –ó–ê–î–ê–ß–£</button>
    </div>

    <div id="tasks-container"></div>

<script>
    const SUPABASE_URL = 'https://ivfksmzhvubfubvfqvpw.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2ZmtzbXpodnViZnVidmZxdnB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNzM0NjYsImV4cCI6MjA1MTg0OTQ2Nn0.89u2Ait783u_jVfC7tX_hX_0nE_w2o22yX_jX_0nE_w'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tg = window.Telegram.WebApp;
    tg.expand();

    let myName = tg.initDataUnsafe?.user?.first_name || '–ê–¥–º–∏–Ω';
    let knownCompanies = [];

    async function init() {
        document.getElementById('task-date').valueAsDate = new Date();
        const user = tg.initDataUnsafe?.user;
        if (user) {
            await supabaseClient.from('team').upsert({ name: user.first_name, telegram_id: user.id.toString() }, { onConflict: 'telegram_id' });
        }
        await loadTeam();
        await loadCompanies();
        await loadTasks();
    }

    async function loadCompanies() {
        const { data } = await supabaseClient.from('companies').select('name').order('name');
        if (data) {
            knownCompanies = data.map(c => c.name);
            document.getElementById('companies-list').innerHTML = data.map(c => `<option value="${c.name}">`).join('');
        }
    }

    async function loadTeam() {
        const { data } = await supabaseClient.from('team').select('*').order('name');
        if (!data) return;
        document.getElementById('team-list').innerHTML = data.map(m => `
            <div class="manager-chip">${m.name === myName ? '‚≠ê –Ø' : m.name} <div class="plus-icon" onclick="quickTask('${m.name}')">+</div></div>
        `).join('');
        document.getElementById('manager-select').innerHTML = '<option value="">üë§ –ö—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç?</option>' + 
            data.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
    }

    function assignToMe() { 
        document.getElementById('manager-select').value = myName; 
        tg.HapticFeedback.impactOccurred('medium');
    }

    function quickTask(name) { 
        document.getElementById('manager-select').value = name; 
        document.getElementById('task-text').focus(); 
    }

    async function addTask() {
        const company = document.getElementById('company-input').value.trim();
        const text = document.getElementById('task-text').value.trim();
        const manager = document.getElementById('manager-select').value || myName;

        if (!company || !text) return tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é –∏ —Ç–µ–∫—Å—Ç!');

        // –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –Ω–æ–≤–∞—è ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë –≤ –±–∞–∑—É
        if (!knownCompanies.includes(company)) {
            await supabaseClient.from('companies').insert([{ name: company }]);
            await loadCompanies(); 
        }

        await supabaseClient.from('tasks').insert([{
            company_name: company,
            task_text: text,
            due_date: document.getElementById('task-date').value,
            due_time: document.getElementById('task-time').value,
            manager_name: manager,
            created_by: myName,
            status: 'in_work'
        }]);

        document.getElementById('task-text').value = '';
        tg.HapticFeedback.notificationOccurred('success');
        loadTasks();
    }

    async function updateStatus(id, newStatus) {
        await supabaseClient.from('tasks').update({ status: newStatus }).eq('id', id);
        loadTasks();
    }

    async function loadTasks() {
        const { data } = await supabaseClient.from('tasks').select('*').order('due_date', { ascending: true });
        const container = document.getElementById('tasks-container');
        container.innerHTML = '';
        const groups = {};
        data?.forEach(t => {
            const d = t.due_date || '–ë–µ–∑ –¥–∞—Ç—ã';
            if (!groups[d]) groups[d] = [];
            groups[d].push(t);
        });

        for (const date in groups) {
            container.innerHTML += `<div class="day-header">${date}</div>`;
            groups[date].forEach(t => {
                const isMine = t.manager_name === myName;
                container.innerHTML += `
                    <div class="task-card status-${t.status} ${isMine ? 'is-mine' : ''}">
                        <div class="company-name">üè¢ ${t.company_name}</div>
                        <div class="task-text">${t.task_text}</div>
                        <div class="meta-line"><span>üïí ${t.due_time || ''} | üë§ ${t.manager_name}</span></div>
                        <div class="actions">
                            <button class="btn-status" onclick="updateStatus(${t.id}, 'completed')">‚úÖ</button>
                            <button class="btn-status" onclick="updateStatus(${t.id}, 'rejected')">‚ùå</button>
                            <button class="btn-status" onclick="updateStatus(${t.id}, 'in_work')">‚è≥</button>
                        </div>
                    </div>`;
            });
        }
    }
    init();
</script>
</body>
</html>
